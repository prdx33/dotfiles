#!/bin/bash
# tools-tui — browsable tool inventory using fzf
# Usage: tools-tui [query]

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
QUERY="${1:-}"

# ── Colour codes for group headers ─────────────────────────────────────
C="\033[36m"  # cyan
D="\033[2m"   # dim
B="\033[1m"   # bold
R="\033[0m"   # reset

# ── Parse tools output into fzf lines ──────────────────────────────────
# Group headers become dimmed separator lines (not selectable)
# Items are compact: "name — description" with hidden group tag at end

raw=$("$SCRIPT_DIR/tools" 2>/dev/null)

lines=()
current_group=""
group_count=0

while IFS= read -r line; do
  stripped=$(echo "$line" | sed 's/\x1b\[[0-9;]*m//g')

  # Detect group header
  if [[ "$stripped" =~ ^([A-Z][A-Z ]+)[[:space:]]*\((.+)\)[[:space:]]*—[[:space:]]*([0-9]+) ]]; then
    current_group="${BASH_REMATCH[1]}"
    current_group=$(echo "$current_group" | xargs)
    local_path="${BASH_REMATCH[2]}"
    local_count="${BASH_REMATCH[3]}"

    # Add visual separator (dimmed, non-selectable via fzf trick)
    if [ $group_count -gt 0 ]; then
      lines+=("")
    fi
    lines+=("$(printf '\033[1;36m%-16s\033[0m \033[2m%s  %s items\033[0m' "$current_group" "$local_path" "$local_count")")
    group_count=$((group_count + 1))
    continue
  fi

  [[ -z "${stripped// /}" ]] && continue

  # Parse item: "  name — description"
  if [[ "$stripped" =~ ^[[:space:]]+([^ ]+)[[:space:]]+—[[:space:]]+(.*) ]]; then
    local_name="${BASH_REMATCH[1]}"
    local_desc="${BASH_REMATCH[2]}"
    # Truncate description to keep lines compact
    if [ ${#local_desc} -gt 60 ]; then
      local_desc="${local_desc:0:57}..."
    fi
    # Format: "  name — desc" with hidden group tag for path resolution
    lines+=("$(printf '  \033[37m%-28s\033[0m \033[2m%s\033[0m \033[8m[%s]\033[0m' "$local_name" "$local_desc" "$current_group")")
  fi
done <<< "$raw"

if [ ${#lines[@]} -eq 0 ]; then
  echo "No entries found"
  exit 1
fi

# ── Path resolution for preview ────────────────────────────────────────
# Embedded in the preview command string to avoid export issues

PREVIEW_CMD='
  line={}
  # Extract hidden group tag [GROUP] from end of line
  stripped=$(echo "$line" | sed "s/\x1b\[[0-9;]*m//g")
  if [[ "$stripped" =~ \[([A-Z ]+)\]$ ]]; then
    group="${BASH_REMATCH[1]}"
  else
    echo "Category header"; exit 0
  fi
  # Extract name (first non-space word)
  name=$(echo "$stripped" | sed "s/\[.*\]//" | xargs | cut -d" " -f1)

  case "$group" in
    SCRIPTS)         path="$HOME/Dev/dotfiles/scripts/$name" ;;
    TOOLS)           path="$HOME/Dev/_tools/$name" ;;
    LABS)            path="$HOME/Dev/_lab/$name" ;;
    EXTERNAL)        path="$HOME/Dev/_external/$name" ;;
    "GO BINARIES")   path="$HOME/go/bin/$name" ;;
    PROJECTS)        path="$HOME/Dev/$name" ;;
    CONFIG)
      case "$name" in
        *.lua) path="$HOME/.hammerspoon/$name" ;;
        *)     path="$HOME/Dev/dotfiles/.config/$name" ;;
      esac ;;
    SERVICES)        path="$HOME/Library/LaunchAgents/${name}.plist" ;;
    HOOKS)           path="$HOME/.claude/hooks/${name}.sh" ;;
    MCP)             echo "MCP integration"; exit 0 ;;
    AGENTS)          path="$HOME/.claude/agents/${name}.md" ;;
    SUPERPOWERS)
      sp_dir="$HOME/.claude/plugins/cache/superpowers-marketplace/superpowers"
      sp_latest=$(/bin/ls -d "$sp_dir"/*/ 2>/dev/null | /usr/bin/sort -V | /usr/bin/tail -1)
      path="${sp_latest}skills/$name/SKILL.md" ;;
    "CLAUDE SKILLS") path="$HOME/.claude/skills/$name/SKILL.md" ;;
    *)               echo "No preview"; exit 0 ;;
  esac

  if [ -f "$path" ]; then
    echo -e "\033[2m$path\033[0m"
    echo ""
    /usr/bin/head -50 "$path"
  elif [ -d "$path" ]; then
    echo -e "\033[2m$path/\033[0m"
    echo ""
    /bin/ls -1 "$path" | /usr/bin/head -25
    [ -f "$path/README.md" ] && echo "" && echo -e "\033[1m── README ──\033[0m" && /usr/bin/head -20 "$path/README.md"
  else
    echo "File not found: $path"
  fi
'

# ── Launch fzf ─────────────────────────────────────────────────────────
selected=$(printf '%s\n' "${lines[@]}" | fzf \
  --ansi \
  --query="$QUERY" \
  --header="↑↓ navigate  /  type to filter  /  tab: preview  /  enter: path  /  esc: quit" \
  --header-first \
  --reverse \
  --border=rounded \
  --border-label=" n0idOS Inventory " \
  --no-margin \
  --padding=0,1 \
  --prompt=" > " \
  --preview="$PREVIEW_CMD" \
  --preview-window=down:40%:wrap:hidden \
  --bind='tab:toggle-preview' \
  --color='border:8,header:8,prompt:6,pointer:6,marker:6,hl:6,hl+:6' \
)

# ── On selection, output the resolved path ─────────────────────────────
if [ -n "$selected" ]; then
  stripped=$(echo "$selected" | sed 's/\x1b\[[0-9;]*m//g')

  # Extract group tag
  if [[ "$stripped" =~ \[([A-Z ]+)\]$ ]]; then
    group="${BASH_REMATCH[1]}"
  else
    exit 0
  fi
  name=$(echo "$stripped" | sed "s/\[.*\]//" | xargs | cut -d" " -f1)

  case "$group" in
    SCRIPTS)         path="$HOME/Dev/dotfiles/scripts/$name" ;;
    TOOLS)           path="$HOME/Dev/_tools/$name" ;;
    LABS)            path="$HOME/Dev/_lab/$name" ;;
    EXTERNAL)        path="$HOME/Dev/_external/$name" ;;
    "GO BINARIES")   path="$HOME/go/bin/$name" ;;
    PROJECTS)        path="$HOME/Dev/$name" ;;
    CONFIG)
      case "$name" in
        *.lua) path="$HOME/.hammerspoon/$name" ;;
        *)     path="$HOME/Dev/dotfiles/.config/$name" ;;
      esac ;;
    SERVICES)        path="$HOME/Library/LaunchAgents/${name}.plist" ;;
    HOOKS)           path="$HOME/.claude/hooks/${name}.sh" ;;
    MCP)             exit 0 ;;
    AGENTS)          path="$HOME/.claude/agents/${name}.md" ;;
    SUPERPOWERS)
      sp_dir="$HOME/.claude/plugins/cache/superpowers-marketplace/superpowers"
      sp_latest=$(ls -d "$sp_dir"/*/ 2>/dev/null | sort -V | tail -1)
      path="${sp_latest}skills/$name/SKILL.md" ;;
    "CLAUDE SKILLS") path="$HOME/.claude/skills/$name/SKILL.md" ;;
    *)               exit 0 ;;
  esac

  [ -n "$path" ] && echo "$path"
fi
