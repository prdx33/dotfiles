#!/bin/bash

# SketchyBar - clean monospace layout
# NOTE: All text should be UPPERCASE throughout the bar
source "$CONFIG_DIR/colours.sh"

PLUGIN_DIR="$CONFIG_DIR/plugins"
ITEM_DIR="$CONFIG_DIR/items"
FONT="Iosevka Extended"
MONO_FONT="Iosevka Extended"

export FONT MONO_FONT PLUGIN_DIR

# Bar - 40% opacity background
sketchybar --bar \
    position=top \
    height=30 \
    color=0x66000000 \
    blur_radius=50 \
    margin=0 \
    y_offset=0 \
    padding_left=8 \
    padding_right=8 \
    notch_width=188 \
    topmost=on \
    sticky=on \
    display=all

# Defaults - monospace font
sketchybar --default \
    icon.font="$MONO_FONT:Bold:11.0" \
    icon.color=0xccffffff \
    label.font="$MONO_FONT:Bold:11.0" \
    label.color=$LABEL_COLOR \
    padding_left=0 \
    padding_right=0 \
    y_offset=1

# === LEFT: Focused app icon ===
sketchybar --add item app_icon left \
    --set app_icon \
        icon.drawing=off \
        label.drawing=off \
        background.image.scale=0.75 \
        background.image.drawing=on \
        background.drawing=on \
        background.color=0x00000000 \
        padding_left=11 \
        padding_right=4 \
        width=20 \
        y_offset=0 \
        script="$PLUGIN_DIR/front_app_icon.sh" \
    --subscribe app_icon front_app_switched

# === LEFT: App name (hover to show menus) ===
sketchybar --add item app_name left \
    --set app_name \
        icon.drawing=off \
        label.font="Iosevka Extended:Heavy:12.0" \
        label.color=0xffffffff \
        label.padding_left=20 \
        label.padding_right=12 \
        label.drawing=on \
        label="APP"

sketchybar --set app_name script="$PLUGIN_DIR/menus_toggle.sh" \
    --subscribe app_name mouse.entered mouse.exited

# === LEFT: Menu bar items (clickable, hidden by default) ===
MAX_MENUS=8
for i in $(seq 0 $((MAX_MENUS - 1))); do
    sketchybar --add item menu.$i left \
        --set menu.$i \
            icon.drawing=off \
            label.font="Iosevka Extended:SemiBold:12.0" \
            label.color=0x99ffffff \
            label.padding_left=0 \
            label.padding_right=0 \
            label.drawing=off \
            background.drawing=off \
            width=0 \
            script="$PLUGIN_DIR/menus_toggle.sh" \
        --subscribe menu.$i mouse.entered mouse.exited
done

# First menu item also triggers the update script on app switch
sketchybar --set menu.0 \
    script="$PLUGIN_DIR/menus.sh" \
    --subscribe menu.0 front_app_switched mouse.entered mouse.exited

# === CENTER: App (M1) | Workspaces | App (M2) ===
source "$ITEM_DIR/spaces.sh"

# === RIGHT: DateTime ===
source "$ITEM_DIR/datetime.sh"

# === RIGHT: Stats (left of datetime) ===
source "$ITEM_DIR/system.sh"

sketchybar --update
