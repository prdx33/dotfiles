<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Corne Keymap Viewer</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&display=swap');

    :root {
      --bg: #0a0a0a;
      --bg-card: #141414;
      --bg-row: #1a1a1a;
      --bg-row-alt: #1e1e1e;
      --bg-key: #1e1e1e;
      --bg-key-hover: #2a2a2a;
      --text: #e8e8e8;
      --text-muted: #888;
      --text-dim: #555;
      --border: #2a2a2a;

      /* Layer colours matching cheat sheet */
      --layer-alpha: #4a9d9a;
      --layer-numnav: #7b9f5c;
      --layer-function: #c98a4b;
      --layer-connect: #9a7bb8;
      --layer-command: #c77da0;

      /* Key type accents */
      --accent-mod-tap: #c98a4b;
      --accent-layer-tap: #4a9d9a;
      --accent-tap-dance: #9a7bb8;
      --accent-combo: #c77da0;
      --accent-transparent: #333;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'JetBrains Mono', monospace;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 32px 48px;
      font-size: 14px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    h1 {
      font-size: 1.75rem;
      font-weight: 500;
    }

    .subtitle {
      color: var(--text-muted);
      font-size: 0.8rem;
      margin-top: 4px;
    }

    .nav {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
    }

    .nav a {
      padding: 10px 20px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.9rem;
      transition: all 0.15s;
    }

    .nav a:hover { background: var(--bg-row); color: var(--text); }
    .nav a.active { background: var(--bg-row); color: var(--text); border-color: #444; }

    /* Legend top bar */
    .legend-top {
      display: flex;
      flex-wrap: wrap;
      gap: 40px;
      padding: 16px 20px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 0.85rem;
    }

    .legend-group {
      display: flex;
      align-items: center;
      gap: 16px;
      flex-wrap: wrap;
    }

    .legend-label {
      color: var(--text-muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.7rem;
      min-width: 50px;
    }

    .legend-entry {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--text);
      font-size: 0.8rem;
    }

    .legend-swatch {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    /* Keyboard container */
    .keyboard-container {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    /* Layer tabs */
    .layer-tabs {
      display: flex;
      justify-content: center;
      gap: 4px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
    }

    .layer-tab {
      padding: 6px 14px;
      font-size: 0.85rem;
      font-family: inherit;
      border-radius: 6px;
      background: transparent;
      border: none;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-dim);
    }

    .layer-tab:hover {
      color: var(--text-muted);
      background: var(--bg-key);
    }

    .layer-tab.active {
      color: var(--bg);
      font-weight: 500;
    }

    .layer-tab-number { opacity: 0.5; font-size: 0.75rem; }
    .layer-tab-name { font-weight: 500; }

    /* Dynamic layer tab colours */
    .layer-tab.active[data-layer="0"] { background: var(--layer-alpha); }
    .layer-tab.active[data-layer="1"] { background: var(--layer-numnav); }
    .layer-tab.active[data-layer="2"] { background: var(--layer-function); }
    .layer-tab.active[data-layer="3"] { background: var(--layer-connect); }
    .layer-tab.active[data-layer="4"] { background: var(--layer-command); }

    /* Keyboard area */
    .keyboard-area {
      position: relative;
      padding: 32px;
    }

    .keyboard {
      display: flex;
      gap: 220px;
      justify-content: center;
      padding: 24px 0;
    }

    .half {
      display: grid;
      grid-template-columns: repeat(6, 60px);
      grid-template-rows: repeat(3, 60px) 68px;
      gap: 8px;
    }

    .half.left .thumb-row {
      grid-column: 4 / 7;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 12px;
    }

    .half.right .thumb-row {
      grid-column: 1 / 4;
      display: flex;
      justify-content: flex-start;
      gap: 8px;
      margin-top: 12px;
    }

    /* Tooltip panel between halves */
    .tooltip-panel {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 200px;
      background: var(--bg-key);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      z-index: 5;
    }

    .tooltip-empty {
      color: var(--text-dim);
      font-size: 0.8rem;
      text-align: center;
    }

    .tooltip-title {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
      text-align: center;
    }

    .tooltip-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      margin-bottom: 6px;
    }

    .tooltip-label { color: var(--text-dim); }
    .tooltip-value { color: var(--text); font-weight: 500; }

    .tooltip-timing {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
      font-size: 0.7rem;
      text-align: center;
      color: var(--text-muted);
    }

    .tooltip-feel {
      color: var(--text-dim);
      font-style: italic;
      margin-top: 6px;
      font-size: 0.7rem;
      line-height: 1.4;
      text-align: center;
    }

    .tooltip-combos {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
    }

    .tooltip-combos-title {
      font-size: 0.7rem;
      color: var(--text-dim);
      margin-bottom: 6px;
    }

    .tooltip-combo-item {
      font-size: 0.7rem;
      color: var(--accent-combo);
      margin-bottom: 3px;
    }

    /* Key styling */
    .key {
      width: 60px;
      height: 60px;
      background: var(--bg-key);
      border: none;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: all 0.15s;
      position: relative;
      padding: 6px;
    }

    .key:hover {
      background: var(--bg-key-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .key.combo-highlight {
      animation: combo-pulse 0.6s ease-in-out infinite alternate;
    }

    @keyframes combo-pulse {
      from { box-shadow: 0 0 0 0 var(--accent-combo); }
      to { box-shadow: 0 0 10px 2px var(--accent-combo); }
    }

    .key.layer-activator {
      background: rgba(74, 157, 154, 0.2);
      box-shadow: inset 0 0 0 1px var(--accent-layer-tap);
    }

    .key.transparent {
      background: var(--bg);
      opacity: 0.4;
    }

    .key.timing-quick {
      box-shadow: inset 0 0 0 2px #444;
    }

    .key.timing-deliberate {
      box-shadow: inset 0 0 0 2px var(--accent-tap-dance), 0 0 12px rgba(154, 123, 184, 0.15);
    }

    .key-tap {
      font-size: 0.85rem;
      font-weight: 500;
      text-align: center;
      line-height: 1.3;
      color: var(--text);
    }

    .key-hold {
      font-size: 0.65rem;
      font-weight: 400;
      text-align: center;
      margin-top: 2px;
    }

    .key-hold.mod-tap { color: var(--accent-mod-tap); }
    .key-hold.layer-tap { color: var(--accent-layer-tap); }

    .combo-indicator {
      position: absolute;
      bottom: 3px;
      right: 4px;
      font-size: 0.65rem;
      font-weight: 500;
      color: var(--accent-combo);
    }

    .td-depth {
      position: absolute;
      top: 3px;
      right: 4px;
      font-size: 0.65rem;
      font-weight: 400;
      color: var(--accent-tap-dance);
    }

    /* SVG combo lines */
    .combo-svg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
    }

    .combo-line {
      stroke: var(--accent-combo);
      stroke-width: 2;
      fill: none;
      opacity: 0.7;
    }

    .combo-result {
      position: absolute;
      background: var(--accent-combo);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.85rem;
      font-weight: 500;
      z-index: 20;
      pointer-events: none;
      white-space: nowrap;
    }

    /* Combo panel */
    .combo-panel {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .combo-panel-header {
      padding: 14px 20px;
      border-radius: 9px 9px 0 0;
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--bg);
      background: var(--accent-combo);
    }

    .combo-panel-header span {
      font-weight: 300;
      opacity: 0.7;
    }

    .combo-categories {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0;
    }

    .combo-category {
      padding: 16px 20px;
      border-right: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
    }

    .combo-category:last-child { border-right: none; }

    .combo-category-title {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-dim);
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .combo-item {
      display: flex;
      align-items: baseline;
      gap: 12px;
      font-size: 0.85rem;
      cursor: pointer;
      border-radius: 5px;
      padding: 6px 8px;
      margin: 0 -8px;
      transition: background 0.1s;
    }

    .combo-item:hover {
      background: var(--bg-key-hover);
    }

    .combo-item.highlight {
      background: rgba(199, 125, 160, 0.15);
    }

    .combo-output {
      font-weight: 600;
      color: var(--text);
      min-width: 50px;
      background: var(--bg);
      padding: 3px 8px;
      border-radius: 5px;
      text-align: center;
      font-size: 0.75rem;
    }

    .combo-keys {
      color: var(--text-dim);
      font-size: 0.8rem;
    }

    .shortcuts-hint {
      font-size: 0.7rem;
      color: var(--text-dim);
      text-align: right;
      margin-top: 12px;
    }

    @media (max-width: 900px) {
      body { padding: 16px; }
      .keyboard { gap: 100px; }
      .half { grid-template-columns: repeat(6, 50px); grid-template-rows: repeat(3, 50px) 58px; }
      .key { width: 50px; height: 50px; }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Corne 42-Key Keymap</h1>
      <p class="subtitle">ZMK firmware -- 42-key split with combos and tap-dances</p>
    </div>
  </header>

  <nav class="nav">
    <a href="index.html">Cheat Sheet</a>
    <a href="window-management-keymap.html">Visual</a>
    <a href="corne-keymap-viewer.html" class="active">Corne</a>
  </nav>

  <div class="legend-top">
    <div class="legend-group">
      <span class="legend-label">Hold</span>
      <span class="legend-entry"><span class="legend-swatch" style="background:var(--accent-mod-tap)"></span>Modifier</span>
      <span class="legend-entry"><span class="legend-swatch" style="background:var(--accent-layer-tap)"></span>Layer</span>
    </div>
    <div class="legend-group">
      <span class="legend-label">Timing</span>
      <span class="legend-entry" style="color:var(--text-dim)">No border = instant</span>
      <span class="legend-entry" style="color:var(--text-dim)">Inner stroke = quick</span>
      <span class="legend-entry" style="color:var(--accent-tap-dance)">Glow = deliberate</span>
    </div>
    <div class="legend-group">
      <span class="legend-label">Indicators</span>
      <span class="legend-entry"><span style="color:var(--accent-combo); font-weight:600">3</span> combo count</span>
      <span class="legend-entry"><span style="color:var(--accent-tap-dance)">...</span> tap-dance</span>
    </div>
  </div>

  <div class="keyboard-container">
    <div class="layer-tabs" id="layerTabs"></div>
    <div class="keyboard-area" id="keyboardArea">
      <div class="keyboard" id="keyboard"></div>
      <div class="tooltip-panel" id="tooltipPanel">
        <div class="tooltip-empty">Hover a key</div>
      </div>
      <svg class="combo-svg" id="comboSvg"></svg>
      <div id="comboResult" class="combo-result" style="display: none;"></div>
    </div>
  </div>

  <div class="combo-panel">
    <div class="combo-panel-header" id="comboPanelTitle">Combos</div>
    <div class="combo-categories" id="comboPanel"></div>
  </div>

  <div class="shortcuts-hint">Keys 1-5 switch layers</div>

  <script>
    // ============================================================
    // KEYMAP DATA (built-in)
    // ============================================================

    const KEYMAP_DATA = {
      layers: [
        {
          name: "ALPHA",
          purpose: "Base QWERTY + mods",
          access: ["Default layer"],
          activatorPositions: [],
          keys: [
            { tap: "Esc", type: "normal" },
            { tap: "Q", type: "normal" },
            { tap: "W", type: "normal" },
            { tap: "E", type: "normal" },
            { tap: "R", type: "normal" },
            { tap: "T", type: "normal" },
            { tap: "Y", type: "normal" },
            { tap: "U", type: "normal" },
            { tap: "I", type: "normal" },
            { tap: "O", type: "normal" },
            { tap: "P", type: "normal" },
            { tap: "\u232b", type: "normal" },
            { tap: "Tab", hold: "Hyper", type: "mod-tap", timing: 175, feel: "Your hyper key lives here." },
            { tap: "A", type: "normal" },
            { tap: "S", type: "normal" },
            { tap: "D", type: "normal" },
            { tap: "F", type: "normal" },
            { tap: "G", type: "normal" },
            { tap: "H", type: "normal" },
            { tap: "J", type: "normal" },
            { tap: "K", type: "normal" },
            { tap: "L", type: "normal" },
            { tap: ";", type: "normal" },
            { tap: "'", type: "normal" },
            { tap: "Shift", type: "normal" },
            { tap: "Z", hold: "Ctrl", type: "mod-tap", timing: 175 },
            { tap: "X", type: "normal" },
            { tap: "C", type: "normal" },
            { tap: "V", type: "normal" },
            { tap: "B", type: "normal" },
            { tap: "N", type: "normal" },
            { tap: "M", type: "normal" },
            { tap: ",", type: "normal" },
            { tap: ".", type: "normal" },
            { tap: "/", type: "normal" },
            { tap: "\\", type: "normal" },
            { tap: "Alt", type: "tap-dance", timing: 350, tdStates: ["Alt", "Meh"], feel: "Double-tap for Meh (Ctrl+Alt+Shift)" },
            { tap: "GUI", type: "tap-dance", timing: 350, tdStates: ["GUI", "L1", "L4"], feel: "Single: Cmd, Double: NUMNAV, Triple: COMMAND" },
            { tap: "Space", type: "normal" },
            { tap: "Enter", type: "normal" },
            { tap: "L1", type: "momentary", hold: "NUMNAV" },
            { tap: "L2", type: "tap-dance", timing: 350, tdStates: ["L2", "L3"], feel: "Single: FUNCTION, Double: CONNECT" }
          ]
        },
        {
          name: "NUMNAV",
          purpose: "Numbers / Arrows / Media",
          access: ["hold L1", "double-tap GUI"],
          activatorPositions: [37, 40],
          keys: [
            { tap: "\u25bd", type: "transparent" },
            { tap: "1", type: "normal" },
            { tap: "2", type: "normal" },
            { tap: "3", type: "normal" },
            { tap: "4", type: "normal" },
            { tap: "5", type: "normal" },
            { tap: "6", type: "normal" },
            { tap: "7", type: "normal" },
            { tap: "8", type: "normal" },
            { tap: "9", type: "normal" },
            { tap: "0", type: "normal" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u2190", type: "normal" },
            { tap: "\u2193", type: "normal" },
            { tap: "\u2191", type: "normal" },
            { tap: "\u2192", type: "normal" },
            { tap: "Mute", type: "normal" },
            { tap: "\u2190", type: "normal" },
            { tap: "\u2193", type: "normal" },
            { tap: "\u2191", type: "normal" },
            { tap: "\u2192", type: "normal" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u23ee", type: "normal" },
            { tap: "Vol-", type: "normal" },
            { tap: "Vol+", type: "normal" },
            { tap: "\u23ed", type: "normal" },
            { tap: "\u23ef", type: "normal" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "GUI", type: "normal" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" }
          ]
        },
        {
          name: "FUNCTION",
          purpose: "F-Keys",
          access: ["tap-dance L2"],
          activatorPositions: [41],
          keys: [
            { tap: "\u25bd", type: "transparent" },
            { tap: "F1", type: "normal" },
            { tap: "F2", type: "normal" },
            { tap: "F3", type: "normal" },
            { tap: "F4", type: "normal" },
            { tap: "F5", type: "normal" },
            { tap: "F1", type: "normal" },
            { tap: "F2", type: "normal" },
            { tap: "F3", type: "normal" },
            { tap: "F4", type: "normal" },
            { tap: "F5", type: "normal" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "F6", type: "normal" },
            { tap: "F7", type: "normal" },
            { tap: "F8", type: "normal" },
            { tap: "F9", type: "normal" },
            { tap: "F10", type: "normal" },
            { tap: "F6", type: "normal" },
            { tap: "F7", type: "normal" },
            { tap: "F8", type: "normal" },
            { tap: "F9", type: "normal" },
            { tap: "F10", type: "normal" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "F11", type: "normal" },
            { tap: "F12", type: "normal" },
            { tap: "F13", type: "normal" },
            { tap: "F14", type: "normal" },
            { tap: "F15", type: "normal" },
            { tap: "F11", type: "normal" },
            { tap: "F12", type: "normal" },
            { tap: "F13", type: "normal" },
            { tap: "F14", type: "normal" },
            { tap: "F15", type: "normal" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" }
          ]
        },
        {
          name: "CONNECT",
          purpose: "Bluetooth",
          access: ["double-tap L2"],
          activatorPositions: [41],
          keys: [
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "Disc0", type: "normal", feel: "Disconnect BT profile 0" },
            { tap: "Disc1", type: "normal", feel: "Disconnect BT profile 1" },
            { tap: "Disc2", type: "normal", feel: "Disconnect BT profile 2" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "Studio", type: "normal", feel: "ZMK Studio unlock" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "BT0", type: "normal", feel: "Bluetooth profile 0" },
            { tap: "BT1", type: "normal", feel: "Bluetooth profile 1" },
            { tap: "BT2", type: "normal", feel: "Bluetooth profile 2" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" }
          ]
        },
        {
          name: "COMMAND",
          purpose: "GUI shortcuts",
          access: ["triple-tap GUI"],
          activatorPositions: [37],
          keys: [
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u23181", type: "normal" },
            { tap: "\u23182", type: "normal" },
            { tap: "\u23183", type: "normal" },
            { tap: "\u23184", type: "normal" },
            { tap: "\u23185", type: "normal" },
            { tap: "\u23186", type: "normal" },
            { tap: "\u23187", type: "normal" },
            { tap: "\u23188", type: "normal" },
            { tap: "\u23189", type: "normal" },
            { tap: "\u23180", type: "normal" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" },
            { tap: "\u25bd", type: "transparent" }
          ]
        }
      ],
      combos: [
        { id: "lh_backspace", positions: [4, 5], result: "\u232b", category: "Editing", keys: "R+T" },
        { id: "lh_delete", positions: [16, 17], result: "Del", category: "Editing", keys: "F+G" },
        { id: "return", positions: [15, 16, 37], result: "Enter", category: "Editing", keys: "D+F+GUI" },
        { id: "esc", positions: [14, 15], result: "Esc", category: "Editing", keys: "S+D" },
        { id: "pgup", positions: [3, 4, 14], result: "PgUp", category: "Navigation", keys: "E+R+S" },
        { id: "pgdn", positions: [14, 15, 16], result: "PgDn", category: "Navigation", keys: "S+D+F" },
        { id: "home", positions: [15, 16, 26], result: "Home", category: "Navigation", keys: "D+F+X" },
        { id: "end", positions: [26, 27, 28], result: "End", category: "Navigation", keys: "X+C+V" },
        { id: "f20", positions: [15, 16], result: "F20", category: "Left Ops", keys: "D+F" },
        { id: "grave", positions: [15, 28], result: "`", category: "Left Ops", keys: "D+V" },
        { id: "tilde", positions: [15, 26], result: "~", category: "Left Ops", keys: "D+X" },
        { id: "left_paren", positions: [20, 31], result: "(", category: "Right Ops", keys: "K+M" },
        { id: "right_paren", positions: [20, 33], result: ")", category: "Right Ops", keys: "K+." },
        { id: "left_bracket", positions: [31, 32], result: "[", category: "Right Ops", keys: "M+," },
        { id: "right_bracket", positions: [32, 33], result: "]", category: "Right Ops", keys: ",+." },
        { id: "minus", positions: [19, 20], result: "-", category: "Right Ops", keys: "J+K" },
        { id: "underscore", positions: [8, 19], result: "_", category: "Right Ops", keys: "I+J" },
        { id: "equal", positions: [20, 21], result: "=", category: "Right Ops", keys: "K+L" },
        { id: "zero", positions: [22, 23], result: "0", category: "Right Ops", keys: ";+'" },
        { id: "rgui", positions: [40, 41], result: "RGUI", category: "Modifiers", keys: "L1+L2" },
        { id: "ralt", positions: [32, 33], result: "RAlt", category: "Modifiers", keys: ",+." },
        { id: "rctrl", positions: [34, 35], result: "RCtrl", category: "Modifiers", keys: "/+\\" },
        { id: "settings", positions: [27, 28], result: "\u2318,", category: "System", keys: "C+V" },
        { id: "toggone", positions: [0, 37], result: "Tog L1", category: "System", keys: "Esc+GUI" },
        { id: "toggtwo", positions: [0, 36], result: "Tog L2", category: "System", keys: "Esc+Alt" },
        { id: "softoff", positions: [0, 11], result: "Soft Off", category: "System", keys: "Esc+\u232b" }
      ]
    };

    // ============================================================
    // STATE
    // ============================================================

    let currentLayer = 0;
    let combosByPosition = {};

    function rebuildComboLookup() {
      combosByPosition = {};
      KEYMAP_DATA.combos.forEach(combo => {
        combo.positions.forEach(pos => {
          if (!combosByPosition[pos]) combosByPosition[pos] = [];
          combosByPosition[pos].push(combo);
        });
      });
    }

    rebuildComboLookup();

    // ============================================================
    // RENDERING
    // ============================================================

    function renderLayerTabs() {
      const container = document.getElementById('layerTabs');
      container.innerHTML = KEYMAP_DATA.layers.map((layer, i) =>
        '<div class="layer-tab ' + (i === currentLayer ? 'active' : '') + '" data-layer="' + i + '">' +
        '<span class="layer-tab-number">' + (i + 1) + '</span>' +
        '<span class="layer-tab-name">' + layer.name + '</span>' +
        '</div>'
      ).join('');

      container.querySelectorAll('.layer-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          currentLayer = parseInt(tab.dataset.layer);
          renderLayerTabs();
          renderKeyboard();
        });
      });
    }

    function getKeyClasses(key, index) {
      const classes = ['key'];

      if (key.type === 'transparent') classes.push('transparent');

      if (key.timing) {
        if (key.timing < 100) { /* no class for instant */ }
        else if (key.timing <= 200) classes.push('timing-quick');
        else classes.push('timing-deliberate');
      }

      const layer = KEYMAP_DATA.layers[currentLayer];
      if (currentLayer > 0 && layer.activatorPositions && layer.activatorPositions.includes(index)) {
        classes.push('layer-activator');
      }

      return classes.join(' ');
    }

    function getHoldClass(key) {
      if (key.type === 'mod-tap') return 'mod-tap';
      if (key.type === 'layer-tap' || key.type === 'momentary') return 'layer-tap';
      return '';
    }

    function getComboIndicator(index) {
      const combos = combosByPosition[index];
      if (!combos || combos.length === 0) return '';
      return '<span class="combo-indicator">' + combos.length + '</span>';
    }

    function getTdDepthIndicator(key) {
      if (key.type !== 'tap-dance' || !key.tdStates) return '';
      const dots = '\u00b7'.repeat(key.tdStates.length);
      return '<span class="td-depth">' + dots + '</span>';
    }

    function renderKeyboard() {
      const keyboard = document.getElementById('keyboard');
      const layer = KEYMAP_DATA.layers[currentLayer];

      if (!layer || !layer.keys) {
        keyboard.innerHTML = '<div style="color: var(--text-muted); padding: 40px;">No keys defined</div>';
        return;
      }

      const leftMain = [0,1,2,3,4,5, 12,13,14,15,16,17, 24,25,26,27,28,29];
      const rightMain = [6,7,8,9,10,11, 18,19,20,21,22,23, 30,31,32,33,34,35];
      const leftThumb = [36,37,38];
      const rightThumb = [39,40,41];

      function renderKey(idx) {
        const key = layer.keys[idx];
        if (!key) return '<div class="key" data-index="' + idx + '"><span class="key-tap">?</span></div>';

        const classes = getKeyClasses(key, idx);
        const comboInd = getComboIndicator(idx);
        const tdInd = getTdDepthIndicator(key);
        const holdClass = getHoldClass(key);

        return '<div class="' + classes + '" data-index="' + idx + '">' +
          tdInd +
          '<span class="key-tap">' + key.tap + '</span>' +
          (key.hold ? '<span class="key-hold ' + holdClass + '">' + key.hold + '</span>' : '') +
          comboInd +
          '</div>';
      }

      keyboard.innerHTML =
        '<div class="half left">' +
        leftMain.map(renderKey).join('') +
        '<div class="thumb-row">' + leftThumb.map(renderKey).join('') + '</div>' +
        '</div>' +
        '<div class="half right">' +
        rightMain.map(renderKey).join('') +
        '<div class="thumb-row">' + rightThumb.map(renderKey).join('') + '</div>' +
        '</div>';

      keyboard.querySelectorAll('.key').forEach(keyEl => {
        const idx = parseInt(keyEl.dataset.index);

        keyEl.addEventListener('mouseenter', () => {
          updateTooltipPanel(layer.keys[idx], idx);
          highlightCombos(idx);
        });

        keyEl.addEventListener('mouseleave', () => {
          clearTooltipPanel();
          clearComboHighlights();
        });
      });
    }

    function updateTooltipPanel(key, index) {
      if (!key) return;

      const panel = document.getElementById('tooltipPanel');
      const combos = combosByPosition[index] || [];

      let timingHtml = '';
      if (key.timing) {
        const desc = key.timing < 100 ? 'Instant response' :
                     key.timing <= 200 ? 'Quick but considered' :
                     'Take your time';
        timingHtml = '<div class="tooltip-timing">' + key.timing + 'ms window' +
          '<div class="tooltip-feel">' + desc + '</div></div>';
      }

      let tdHtml = '';
      if (key.type === 'tap-dance' && key.tdStates) {
        tdHtml = key.tdStates.map((state, i) =>
          '<div class="tooltip-row">' +
          '<span class="tooltip-label">' + (i + 1) + '\u00d7 tap</span>' +
          '<span class="tooltip-value">' + state + '</span>' +
          '</div>'
        ).join('');
      }

      let combosHtml = '';
      if (combos.length > 0) {
        combosHtml = '<div class="tooltip-combos">' +
          '<div class="tooltip-combos-title">Combos</div>' +
          combos.map(c =>
            '<div class="tooltip-combo-item">' + c.keys + ' \u2192 ' + c.result + '</div>'
          ).join('') +
          '</div>';
      }

      let feelHtml = '';
      if (key.feel) {
        feelHtml = '<div class="tooltip-feel">' + key.feel + '</div>';
      }

      panel.innerHTML =
        '<div class="tooltip-title">' + key.tap + (key.hold ? ' / ' + key.hold : '') + '</div>' +
        (key.type !== 'normal' && key.type !== 'transparent' ?
          '<div class="tooltip-row"><span class="tooltip-label">Type</span><span class="tooltip-value">' + key.type + '</span></div>' : '') +
        tdHtml +
        timingHtml +
        feelHtml +
        combosHtml;
    }

    function clearTooltipPanel() {
      document.getElementById('tooltipPanel').innerHTML =
        '<div class="tooltip-empty">Hover a key</div>';
    }

    function highlightCombos(index) {
      const combos = combosByPosition[index] || [];
      if (combos.length === 0) return;

      const keyboard = document.getElementById('keyboard');
      const svg = document.getElementById('comboSvg');
      const resultEl = document.getElementById('comboResult');

      svg.innerHTML = '';
      resultEl.style.display = 'none';

      combos.forEach(combo => {
        combo.positions.forEach(pos => {
          const keyEl = keyboard.querySelector('[data-index="' + pos + '"]');
          if (keyEl) keyEl.classList.add('combo-highlight');
        });
      });

      if (combos.length > 0) {
        drawComboLines(combos[0]);
      }
    }

    function drawComboLines(combo) {
      const keyboard = document.getElementById('keyboard');
      const svg = document.getElementById('comboSvg');
      const container = document.getElementById('keyboardArea');
      const resultEl = document.getElementById('comboResult');

      const containerRect = container.getBoundingClientRect();
      svg.setAttribute('width', containerRect.width);
      svg.setAttribute('height', containerRect.height);

      const positions = combo.positions.map(pos => {
        const keyEl = keyboard.querySelector('[data-index="' + pos + '"]');
        if (!keyEl) return null;
        const rect = keyEl.getBoundingClientRect();
        return {
          x: rect.left - containerRect.left + rect.width / 2,
          y: rect.top - containerRect.top + rect.height / 2
        };
      }).filter(p => p);

      if (positions.length < 2) return;

      const centroid = {
        x: positions.reduce((sum, p) => sum + p.x, 0) / positions.length,
        y: positions.reduce((sum, p) => sum + p.y, 0) / positions.length
      };

      positions.forEach(pos => {
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', pos.x);
        line.setAttribute('y1', pos.y);
        line.setAttribute('x2', centroid.x);
        line.setAttribute('y2', centroid.y);
        line.classList.add('combo-line');
        svg.appendChild(line);
      });

      resultEl.textContent = combo.result;
      resultEl.style.left = (centroid.x - 20) + 'px';
      resultEl.style.top = (centroid.y - 12) + 'px';
      resultEl.style.display = 'block';
    }

    function clearComboHighlights() {
      document.querySelectorAll('.key.combo-highlight').forEach(el => {
        el.classList.remove('combo-highlight');
      });
      document.getElementById('comboSvg').innerHTML = '';
      document.getElementById('comboResult').style.display = 'none';
    }

    function renderComboPanel() {
      const panel = document.getElementById('comboPanel');
      const titleEl = document.getElementById('comboPanelTitle');
      const categories = {};

      const categoryOrder = ['Editing', 'Navigation', 'Left Ops', 'Right Ops', 'Modifiers', 'System'];

      KEYMAP_DATA.combos.forEach(combo => {
        if (!categories[combo.category]) categories[combo.category] = [];
        categories[combo.category].push(combo);
      });

      titleEl.innerHTML = 'Combos <span>(' + KEYMAP_DATA.combos.length + ')</span>';

      const sortedCategories = Object.entries(categories).sort((a, b) => {
        const aIdx = categoryOrder.indexOf(a[0]);
        const bIdx = categoryOrder.indexOf(b[0]);
        if (aIdx === -1 && bIdx === -1) return 0;
        if (aIdx === -1) return 1;
        if (bIdx === -1) return -1;
        return aIdx - bIdx;
      });

      panel.innerHTML = sortedCategories.map(([cat, combos]) =>
        '<div class="combo-category">' +
        '<div class="combo-category-title">' + cat + '</div>' +
        combos.map(c =>
          '<div class="combo-item" data-combo-id="' + c.id + '">' +
          '<span class="combo-output">' + c.result + '</span>' +
          '<span class="combo-keys">' + c.keys + '</span>' +
          '</div>'
        ).join('') +
        '</div>'
      ).join('');

      panel.querySelectorAll('.combo-item').forEach(item => {
        const comboId = item.dataset.comboId;
        const combo = KEYMAP_DATA.combos.find(c => c.id === comboId);

        item.addEventListener('mouseenter', () => {
          item.classList.add('highlight');
          if (combo) {
            combo.positions.forEach(pos => {
              const keyEl = document.querySelector('[data-index="' + pos + '"]');
              if (keyEl) keyEl.classList.add('combo-highlight');
            });
            drawComboLines(combo);
          }
        });

        item.addEventListener('mouseleave', () => {
          item.classList.remove('highlight');
          clearComboHighlights();
        });
      });
    }

    function renderAll() {
      renderLayerTabs();
      renderKeyboard();
      renderComboPanel();
    }

    // ============================================================
    // KEYBOARD SHORTCUTS
    // ============================================================

    document.addEventListener('keydown', (e) => {
      const num = parseInt(e.key);
      if (num >= 1 && num <= KEYMAP_DATA.layers.length) {
        currentLayer = num - 1;
        renderLayerTabs();
        renderKeyboard();
      }
    });

    // ============================================================
    // INIT
    // ============================================================

    renderAll();
  </script>
</body>
</html>
