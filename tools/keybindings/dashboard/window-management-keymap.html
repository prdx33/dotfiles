<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Window Management Keymap</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&display=swap');

    :root {
      --bg: #0a0a0a;
      --bg-card: #141414;
      --bg-row: #1a1a1a;
      --bg-row-alt: #1e1e1e;
      --bg-key: #1e1e1e;
      --bg-key-hover: #2a2a2a;
      --text: #e8e8e8;
      --text-muted: #888;
      --text-dim: #555;
      --border: #2a2a2a;

      --hyper: #4a9d9a;
      --alt: #7b9f5c;
      --alt-shift: #c98a4b;
      --service: #9a7bb8;

      --karabiner: #8b7bc7;
      --aerospace: #5ba3c9;
      --rectangle: #c77da0;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'JetBrains Mono', monospace;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 32px 48px;
      font-size: 14px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }

    h1 {
      font-size: 1.75rem;
      font-weight: 500;
    }

    .subtitle {
      color: var(--text-muted);
      font-size: 0.8rem;
      margin-top: 4px;
    }

    .nav {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
    }

    .nav a {
      padding: 10px 20px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-muted);
      text-decoration: none;
      font-size: 0.9rem;
      transition: all 0.15s;
    }

    .nav a:hover { background: var(--bg-row); color: var(--text); }
    .nav a.active { background: var(--bg-row); color: var(--text); border-color: #444; }

    /* Keyboard container */
    .keyboard-container {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    /* Layer tabs */
    .layer-tabs {
      display: flex;
      justify-content: center;
      gap: 4px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
    }

    .layer-tab {
      padding: 6px 14px;
      font-size: 0.85rem;
      font-family: inherit;
      border-radius: 6px;
      background: transparent;
      border: none;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-dim);
    }

    .layer-tab:hover {
      color: var(--text-muted);
      background: var(--bg-key);
    }

    .layer-tab.active {
      color: var(--bg);
      font-weight: 500;
    }

    .layer-tab.active[data-layer="hyper"] { background: var(--hyper); }
    .layer-tab.active[data-layer="alt"] { background: var(--alt); }
    .layer-tab.active[data-layer="alt-shift"] { background: var(--alt-shift); }
    .layer-tab.active[data-layer="service"] { background: var(--service); }

    .layer-tab-number { opacity: 0.5; font-size: 0.75rem; }
    .layer-tab-name { font-weight: 500; }

    /* Keyboard area */
    .keyboard-area {
      position: relative;
      padding: 32px;
    }

    .keyboard {
      display: flex;
      gap: 220px;
      justify-content: center;
      padding: 24px 0;
    }

    .half {
      display: grid;
      grid-template-columns: repeat(6, 64px);
      grid-template-rows: repeat(3, 64px) 72px;
      gap: 6px;
    }

    .half.left .thumb-row {
      grid-column: 4 / 7;
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 12px;
    }

    .half.right .thumb-row {
      grid-column: 1 / 4;
      display: flex;
      justify-content: flex-start;
      gap: 6px;
      margin-top: 12px;
    }

    /* Tooltip panel between halves */
    .tooltip-panel {
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 200px;
      background: var(--bg-key);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      z-index: 5;
    }

    .tooltip-empty {
      color: var(--text-dim);
      font-size: 0.8rem;
      text-align: center;
    }

    .tooltip-title {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
      text-align: center;
    }

    .tooltip-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      margin-bottom: 6px;
    }

    .tooltip-label { color: var(--text-dim); }
    .tooltip-value { color: var(--text); font-weight: 500; }

    .tooltip-desc {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
      font-size: 0.7rem;
      color: var(--text-dim);
      line-height: 1.4;
      text-align: center;
    }

    .tooltip-others {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
    }

    .tooltip-others-title {
      font-size: 0.7rem;
      color: var(--text-dim);
      margin-bottom: 6px;
    }

    .tooltip-other-item {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-bottom: 3px;
    }

    .tooltip-locked {
      margin-top: 8px;
      font-size: 0.7rem;
      color: var(--text-dim);
      text-align: center;
      font-style: italic;
    }

    /* Key styling */
    .key {
      width: 64px;
      height: 64px;
      background: var(--bg-key);
      border: none;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      transition: all 0.15s;
      position: relative;
      padding: 4px;
      gap: 2px;
    }

    .key:hover {
      background: var(--bg-key-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .key.locked {
      box-shadow: 0 0 0 2px var(--text-muted);
    }

    .key.unbound { opacity: 0.3; }

    .key.layer-activator {
      background: rgba(74, 157, 154, 0.15);
      box-shadow: inset 0 0 0 2px var(--hyper);
    }

    .key.layer-activator.alt-activator {
      background: rgba(123, 159, 92, 0.15);
      box-shadow: inset 0 0 0 2px var(--alt);
    }

    .key.layer-activator.service-activator {
      background: rgba(154, 123, 184, 0.15);
      box-shadow: inset 0 0 0 2px var(--service);
    }

    /* Source dot on key */
    .key.has-binding::before {
      content: '';
      position: absolute;
      bottom: 3px;
      right: 3px;
      width: 5px;
      height: 5px;
      border-radius: 50%;
    }

    .key.source-karabiner::before { background: var(--karabiner); }
    .key.source-aerospace::before { background: var(--aerospace); }
    .key.source-rectangle::before { background: var(--rectangle); }

    .key-label {
      font-size: 0.65rem;
      color: var(--text-dim);
      line-height: 1;
    }

    .key-action {
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text);
      text-align: center;
      line-height: 1.1;
    }

    .key-action-secondary {
      font-size: 0.6rem;
      font-weight: 400;
      color: var(--text-dim);
      text-align: center;
      line-height: 1;
    }

    .key-dual {
      font-size: 0.55rem;
      color: var(--text-dim);
      text-align: center;
      line-height: 1;
      margin-top: 1px;
    }

    /* Reference panel below keyboard */
    .ref-panel {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .ref-panel-header {
      padding: 12px 20px;
      border-radius: 9px 9px 0 0;
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--bg);
    }

    .ref-panel-header.hyper { background: var(--hyper); }
    .ref-panel-header.alt { background: var(--alt); }
    .ref-panel-header.alt-shift { background: var(--alt-shift); }
    .ref-panel-header.service { background: var(--service); }

    .ref-panel-body {
      padding: 8px 0;
    }

    .ref-row {
      display: grid;
      align-items: center;
      padding: 8px 20px;
      gap: 16px;
      font-size: 0.85rem;
    }

    .ref-row:nth-child(odd) { background: var(--bg-row); }
    .ref-row:nth-child(even) { background: var(--bg-row-alt); }

    .ref-row.three-col {
      grid-template-columns: 48px 1fr 1fr auto;
    }

    .ref-row.two-col {
      grid-template-columns: 48px 1fr auto;
    }

    .ref-key {
      font-weight: 600;
      color: var(--text);
      background: var(--bg);
      padding: 4px 8px;
      border-radius: 5px;
      text-align: center;
      font-size: 0.75rem;
    }

    .ref-action {
      color: var(--text);
      font-weight: 500;
    }

    .ref-tile {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .ref-source-dots {
      display: flex;
      gap: 3px;
      justify-content: flex-end;
    }

    .ref-source-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }

    .ref-source-dot.karabiner { background: var(--karabiner); }
    .ref-source-dot.aerospace { background: var(--aerospace); }
    .ref-source-dot.rectangle { background: var(--rectangle); }

    /* Legend */
    .legend-top {
      display: flex;
      flex-wrap: wrap;
      gap: 40px;
      padding: 16px 20px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 0.85rem;
    }

    .legend-group {
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    .legend-label {
      color: var(--text-muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.7rem;
      min-width: 50px;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--text);
      padding: 5px 12px;
      border-radius: 20px;
      background: var(--bg);
    }

    .source-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--text);
    }

    .source-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .source-dot.karabiner { background: var(--karabiner); }
    .source-dot.aerospace { background: var(--aerospace); }
    .source-dot.rectangle { background: var(--rectangle); }

    .layer-pill {
      padding: 6px 14px;
      border-radius: 6px;
      font-weight: 500;
      color: var(--bg);
    }

    .layer-pill.hyper { background: var(--hyper); }
    .layer-pill.alt { background: var(--alt); }
    .layer-pill.alt-shift { background: var(--alt-shift); }
    .layer-pill.service { background: var(--service); }

    .shortcuts-hint {
      font-size: 0.7rem;
      color: var(--text-dim);
      text-align: right;
      margin-top: 12px;
    }

    @media (max-width: 900px) {
      body { padding: 16px; }
      .keyboard { gap: 100px; }
      .half { grid-template-columns: repeat(6, 52px); grid-template-rows: repeat(3, 52px) 60px; }
      .key { width: 52px; height: 52px; }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Window Management Keymap</h1>
      <p class="subtitle">AeroSpace + Karabiner + Rectangle (float default, tile opt-in)</p>
    </div>
  </header>

  <nav class="nav">
    <a href="index.html">Cheat Sheet</a>
    <a href="window-management-keymap.html" class="active">Visual</a>
    <a href="corne-keymap-viewer.html">Corne</a>
  </nav>

  <div class="legend-top">
    <div class="legend-group">
      <span class="legend-label">Layer</span>
      <span class="layer-pill hyper">Hyper</span>
      <span class="layer-pill alt">Alt</span>
      <span class="layer-pill alt-shift">Alt+Shift</span>
      <span class="layer-pill service">Service</span>
    </div>
    <div class="legend-group">
      <span class="legend-label">Source</span>
      <span class="source-item"><span class="source-dot karabiner"></span>Karabiner</span>
      <span class="source-item"><span class="source-dot aerospace"></span>AeroSpace</span>
      <span class="source-item"><span class="source-dot rectangle"></span>Rectangle</span>
    </div>
  </div>

  <div class="keyboard-container">
    <div class="layer-tabs" id="layerTabs">
      <div class="layer-tab active" data-layer="hyper">
        <span class="layer-tab-number">1</span>
        <span class="layer-tab-name">Hyper</span>
      </div>
      <div class="layer-tab" data-layer="alt">
        <span class="layer-tab-number">2</span>
        <span class="layer-tab-name">Alt</span>
      </div>
      <div class="layer-tab" data-layer="alt-shift">
        <span class="layer-tab-number">3</span>
        <span class="layer-tab-name">Alt+Shift</span>
      </div>
      <div class="layer-tab" data-layer="service">
        <span class="layer-tab-number">4</span>
        <span class="layer-tab-name">Service</span>
      </div>
    </div>

    <div class="keyboard-area">
      <div class="keyboard" id="keyboard"></div>
      <div class="tooltip-panel" id="tooltipPanel">
        <div class="tooltip-empty">Hover a key</div>
      </div>
    </div>
  </div>

  <div id="refPanel"></div>

  <div class="shortcuts-hint">Keys 1-4 switch layers | Click key to lock tooltip</div>

  <script>
    // ============================================================
    // DATA
    // ============================================================

    const LAYERS = {
      hyper: {
        name: "Hyper",
        activator: "Tab (hold)",
        activatorKeys: ["tab"],
        bindings: {
          q: { action: "Cascade", floatAction: "Cascade", tileAction: null, source: "karabiner", sources: ["karabiner", "rectangle"], desc: "Cascade all floating windows" },
          w: { action: "Foc Prev", floatAction: "Focus prev", tileAction: "Focus prev", source: "karabiner", sources: ["karabiner", "aerospace"], desc: "Focus previous window" },
          e: { action: "Max", floatAction: "Maximize", tileAction: "Move up", source: "karabiner", sources: ["karabiner", "rectangle", "aerospace"], desc: "Maximize (float) or move up (tiled)" },
          r: { action: "Foc Next", floatAction: "Focus next", tileAction: "Focus next", source: "karabiner", sources: ["karabiner", "aerospace"], desc: "Focus next window" },
          t: { action: "Foc Mon", floatAction: "Focus monitor", tileAction: "Focus monitor", source: "karabiner", sources: ["karabiner", "aerospace"], desc: "Focus next monitor" },
          a: { action: "All F/T", floatAction: "All float/tile", tileAction: "All float/tile", source: "karabiner", sources: ["karabiner", "aerospace"], desc: "Toggle ALL windows float/tile" },
          s: { action: "\u2153 L", floatAction: "Left \u2153", tileAction: "Move left", source: "karabiner", sources: ["karabiner", "rectangle", "aerospace"], desc: "Left third (float) or move left (tiled)" },
          d: { action: "\u2153 C", floatAction: "Center \u2153", tileAction: "Move down", source: "karabiner", sources: ["karabiner", "rectangle", "aerospace"], desc: "Center third (float) or move down (tiled)" },
          f: { action: "\u2153 R", floatAction: "Right \u2153", tileAction: "Move right", source: "karabiner", sources: ["karabiner", "rectangle", "aerospace"], desc: "Right third (float) or move right (tiled)" },
          g: { action: "Win\u2192Mon", floatAction: "Win to mon", tileAction: "Win to mon", source: "karabiner", sources: ["karabiner", "aerospace"], desc: "Move window to next monitor + follow" },
          z: { action: "Float", floatAction: "Toggle float", tileAction: "Toggle float", source: "karabiner", sources: ["karabiner", "aerospace"], desc: "Toggle float/tile for focused window" },
          x: { action: "\u2154 L", floatAction: "Left \u2154", tileAction: "Shrink", source: "karabiner", sources: ["karabiner", "rectangle", "aerospace"], desc: "Left two-thirds (float) or shrink (tiled)" },
          c: { action: "\u2154 C", floatAction: "Center \u2154", tileAction: "Flatten+h", source: "karabiner", sources: ["karabiner", "rectangle", "aerospace"], desc: "Center two-thirds (float) or flatten + h-tiles (tiled)" },
          v: { action: "\u2154 R", floatAction: "Right \u2154", tileAction: "Grow", source: "karabiner", sources: ["karabiner", "rectangle", "aerospace"], desc: "Right two-thirds (float) or grow (tiled)" },
          b: { action: "Swap Mon", floatAction: "Swap monitors", tileAction: "Swap monitors", source: "karabiner", sources: ["karabiner", "aerospace"], desc: "Swap workspaces between monitors" },
          semicolon: { action: "Svc", floatAction: "Service mode", tileAction: "Service mode", source: "karabiner", sources: ["karabiner", "aerospace"], desc: "Enter AeroSpace service mode" },
          quote: { action: "Bar", floatAction: "Toggle bar", tileAction: "Toggle bar", source: "karabiner", sources: ["karabiner"], desc: "Toggle SketchyBar visibility" },
          slash: { action: "Sort", floatAction: "Sort windows", tileAction: "Sort windows", source: "karabiner", sources: ["karabiner", "aerospace"], desc: "Sort windows by app into workspaces" }
        }
      },
      alt: {
        name: "Alt",
        activator: "Option",
        activatorKeys: ["alt"],
        bindings: {
          b: { action: "B", app: "Bloom", source: "aerospace", sources: ["aerospace"], desc: "Workspace B (Bloom)" },
          c: { action: "C", app: "Claude", source: "aerospace", sources: ["aerospace"], desc: "Workspace C (Claude)" },
          d: { action: "D", app: "Obsidian", source: "aerospace", sources: ["aerospace"], desc: "Workspace D (Obsidian)" },
          f: { action: "F", app: "Firefox", source: "aerospace", sources: ["aerospace"], desc: "Workspace F (Firefox)" },
          g: { action: "G", app: "Ghostty", source: "aerospace", sources: ["aerospace"], desc: "Workspace G (Ghostty)" },
          i: { action: "I", app: "Sys Info", source: "aerospace", sources: ["aerospace"], desc: "Workspace I (System Info)" },
          k: { action: "K", app: "Karabiner", source: "aerospace", sources: ["aerospace"], desc: "Workspace K (Karabiner)" },
          l: { action: "L", app: "LM Studio", source: "aerospace", sources: ["aerospace"], desc: "Workspace L (LM Studio)" },
          r: { action: "R", app: "Spark", source: "aerospace", sources: ["aerospace"], desc: "Workspace R (Spark)" },
          s: { action: "S", app: "Spotify", source: "aerospace", sources: ["aerospace"], desc: "Workspace S (Spotify)" },
          v: { action: "V", app: "VS Code", source: "aerospace", sources: ["aerospace"], desc: "Workspace V (VS Code)" },
          w: { action: "W", app: "WhatsApp", source: "aerospace", sources: ["aerospace"], desc: "Workspace W (WhatsApp)" }
        }
      },
      "alt-shift": {
        name: "Alt+Shift",
        activator: "Opt+Shift",
        activatorKeys: ["alt", "shift"],
        bindings: {
          b: { action: "\u2192B", app: "Bloom", source: "aerospace", sources: ["aerospace"], desc: "Move window to B + follow" },
          c: { action: "\u2192C", app: "Claude", source: "aerospace", sources: ["aerospace"], desc: "Move window to C + follow" },
          d: { action: "\u2192D", app: "Obsidian", source: "aerospace", sources: ["aerospace"], desc: "Move window to D + follow" },
          f: { action: "\u2192F", app: "Firefox", source: "aerospace", sources: ["aerospace"], desc: "Move window to F + follow" },
          g: { action: "\u2192G", app: "Ghostty", source: "aerospace", sources: ["aerospace"], desc: "Move window to G + follow" },
          i: { action: "\u2192I", app: "Sys Info", source: "aerospace", sources: ["aerospace"], desc: "Move window to I + follow" },
          k: { action: "\u2192K", app: "Karabiner", source: "aerospace", sources: ["aerospace"], desc: "Move window to K + follow" },
          l: { action: "\u2192L", app: "LM Studio", source: "aerospace", sources: ["aerospace"], desc: "Move window to L + follow" },
          r: { action: "\u2192R", app: "Spark", source: "aerospace", sources: ["aerospace"], desc: "Move window to R + follow" },
          s: { action: "\u2192S", app: "Spotify", source: "aerospace", sources: ["aerospace"], desc: "Move window to S + follow" },
          v: { action: "\u2192V", app: "VS Code", source: "aerospace", sources: ["aerospace"], desc: "Move window to V + follow" },
          w: { action: "\u2192W", app: "WhatsApp", source: "aerospace", sources: ["aerospace"], desc: "Move window to W + follow" }
        }
      },
      service: {
        name: "Service",
        activator: "Hyper+;",
        activatorKeys: ["tab", "semicolon"],
        bindings: {
          esc: { action: "Back", source: "aerospace", sources: ["aerospace"], desc: "Back to main mode" },
          r: { action: "Reload", source: "aerospace", sources: ["aerospace"], desc: "Reload AeroSpace config" },
          q: { action: "Close", source: "aerospace", sources: ["aerospace"], desc: "Close all windows but current" },
          d: { action: "Toggle", source: "aerospace", sources: ["aerospace"], desc: "Enable/disable AeroSpace" },
          f: { action: "Flatten", source: "aerospace", sources: ["aerospace"], desc: "Flatten workspace tree" }
        }
      }
    };

    // Corne physical layout - keys by position
    const CORNE = {
      left: [
        ['tab','q','w','e','r','t'],
        ['esc','a','s','d','f','g'],
        ['shift','z','x','c','v','b']
      ],
      leftThumb: ['alt','cmd','space'],
      right: [
        ['y','u','i','o','p','backslash'],
        ['h','j','k','l','semicolon','quote'],
        ['n','m','comma','period','slash','enter']
      ],
      rightThumb: ['backspace','layer','ctrl']
    };

    const KEY_LABELS = {
      tab:'Tab', esc:'Esc', shift:'Shift', alt:'Alt', cmd:'Cmd', space:'Spc',
      backspace:'Bksp', layer:'L1', ctrl:'Ctrl', backslash:'\\', semicolon:';',
      quote:"'", comma:',', period:'.', slash:'/', enter:'Ent',
      q:'Q', w:'W', e:'E', r:'R', t:'T', y:'Y', u:'U', i:'I', o:'O', p:'P',
      a:'A', s:'S', d:'D', f:'F', g:'G', h:'H', j:'J', k:'K', l:'L',
      z:'Z', x:'X', c:'C', v:'V', b:'B', n:'N', m:'M'
    };

    const LAYER_ORDER = ['hyper', 'alt', 'alt-shift', 'service'];
    const QWERTY_ORDER = 'qwertyuiopasdfghjklzxcvbnm';

    // ============================================================
    // STATE
    // ============================================================

    let currentLayer = 'hyper';
    let lockedKey = null;

    // ============================================================
    // RENDER
    // ============================================================

    function renderTabs() {
      document.querySelectorAll('.layer-tab').forEach(t => {
        t.classList.toggle('active', t.dataset.layer === currentLayer);
      });
    }

    function renderKeyboard() {
      const kb = document.getElementById('keyboard');
      const layer = LAYERS[currentLayer];

      function renderKey(k) {
        const b = layer.bindings[k] || null;
        const label = KEY_LABELS[k] || k.toUpperCase();
        const isActivator = layer.activatorKeys.includes(k);

        let cls = ['key'];
        if (b) {
          cls.push('has-binding', 'source-' + b.source);
        } else {
          cls.push('unbound');
        }
        if (lockedKey === k) cls.push('locked');
        if (isActivator) {
          cls.push('layer-activator');
          if (currentLayer === 'alt' || currentLayer === 'alt-shift') cls.push('alt-activator');
          if (currentLayer === 'service') cls.push('service-activator');
        }

        let actionHtml = '';
        if (b) {
          actionHtml = '<span class="key-action">' + b.action + '</span>';
          // Show app name for workspace layers
          if (b.app) {
            actionHtml += '<span class="key-action-secondary">' + b.app + '</span>';
          }
          // Show dual-mode hint for hyper layer
          if (b.tileAction && b.floatAction && b.tileAction !== b.floatAction) {
            actionHtml += '<span class="key-dual">tile: ' + b.tileAction + '</span>';
          }
        }

        return '<div class="key ' + cls.join(' ') + '" data-key="' + k + '">' +
          '<span class="key-label">' + label + '</span>' +
          actionHtml +
          '</div>';
      }

      function renderHalf(rows, thumb, side) {
        let html = '<div class="half ' + side + '">';
        for (const row of rows) {
          html += row.map(renderKey).join('');
        }
        html += '<div class="thumb-row">' + thumb.map(renderKey).join('') + '</div>';
        html += '</div>';
        return html;
      }

      kb.innerHTML = renderHalf(CORNE.left, CORNE.leftThumb, 'left') +
                     renderHalf(CORNE.right, CORNE.rightThumb, 'right');

      kb.querySelectorAll('.key').forEach(el => {
        const k = el.dataset.key;
        el.addEventListener('mouseenter', () => {
          if (!lockedKey) updateTooltip(k);
        });
        el.addEventListener('mouseleave', () => {
          if (!lockedKey) clearTooltip();
        });
        el.addEventListener('click', () => {
          lockedKey = lockedKey === k ? null : k;
          renderKeyboard();
          if (lockedKey) updateTooltip(k); else clearTooltip();
        });
      });
    }

    function updateTooltip(k) {
      const panel = document.getElementById('tooltipPanel');
      const layer = LAYERS[currentLayer];
      const b = layer.bindings[k];

      if (!b) {
        panel.innerHTML = '<div class="tooltip-empty">No binding</div>';
        return;
      }

      // Source dots
      const dotsHtml = (b.sources || [b.source]).map(s =>
        '<span class="ref-source-dot ' + s + '"></span>'
      ).join('');

      // Other layers
      const others = LAYER_ORDER.filter(n => n !== currentLayer)
        .map(n => ({ name: n, b: LAYERS[n].bindings[k] }))
        .filter(x => x.b);

      const othersHtml = others.length ? '<div class="tooltip-others">' +
        '<div class="tooltip-others-title">Other layers</div>' +
        others.map(x => '<div class="tooltip-other-item">' + LAYERS[x.name].name + ': ' + x.b.action + '</div>').join('') +
        '</div>' : '';

      // Dual mode detail for hyper
      let dualHtml = '';
      if (b.floatAction && b.tileAction && b.floatAction !== b.tileAction) {
        dualHtml = '<div class="tooltip-row"><span class="tooltip-label">Float</span><span class="tooltip-value">' + b.floatAction + '</span></div>' +
                   '<div class="tooltip-row"><span class="tooltip-label">Tile</span><span class="tooltip-value">' + b.tileAction + '</span></div>';
      }

      const lockedHtml = lockedKey === k ? '<div class="tooltip-locked">Click to unlock</div>' : '';

      panel.innerHTML =
        '<div class="tooltip-title">' + b.action + '</div>' +
        '<div class="tooltip-row"><span class="tooltip-label">Source</span><span class="tooltip-value" style="display:flex;gap:3px;align-items:center">' + dotsHtml + '</span></div>' +
        dualHtml +
        (b.app ? '<div class="tooltip-row"><span class="tooltip-label">App</span><span class="tooltip-value">' + b.app + '</span></div>' : '') +
        '<div class="tooltip-desc">' + (b.desc || '') + '</div>' +
        othersHtml +
        lockedHtml;
    }

    function clearTooltip() {
      document.getElementById('tooltipPanel').innerHTML = '<div class="tooltip-empty">Hover a key</div>';
    }

    function renderRefPanel() {
      const container = document.getElementById('refPanel');
      const layer = LAYERS[currentLayer];
      const bindings = Object.entries(layer.bindings);

      // Sort by QWERTY position
      bindings.sort((a, b) => {
        const aKey = a[0].toLowerCase();
        const bKey = b[0].toLowerCase();
        const aIdx = QWERTY_ORDER.indexOf(aKey);
        const bIdx = QWERTY_ORDER.indexOf(bKey);
        const aPos = aIdx === -1 ? 100 : aIdx;
        const bPos = bIdx === -1 ? 100 : bIdx;
        return aPos - bPos;
      });

      const layerClass = currentLayer === 'alt-shift' ? 'alt-shift' : currentLayer;
      let html = '<div class="ref-panel">';
      html += '<div class="ref-panel-header ' + layerClass + '">' + layer.name + ' <span style="font-weight:300;opacity:0.7">- ' + layer.activator + '</span></div>';
      html += '<div class="ref-panel-body">';

      // Hyper layer gets 3-column layout (float/tile)
      if (currentLayer === 'hyper') {
        for (const [key, b] of bindings) {
          const keyLabel = KEY_LABELS[key] || key.toUpperCase();
          const dotsHtml = (b.sources || [b.source]).map(s =>
            '<span class="ref-source-dot ' + s + '"></span>'
          ).join('');

          const tileText = (b.tileAction && b.tileAction !== b.floatAction) ? b.tileAction : '';

          html += '<div class="ref-row three-col">' +
            '<span class="ref-key">' + keyLabel + '</span>' +
            '<span class="ref-action">' + (b.floatAction || b.action) + '</span>' +
            '<span class="ref-tile">' + (tileText ? 'tile: ' + tileText : '') + '</span>' +
            '<span class="ref-source-dots">' + dotsHtml + '</span>' +
            '</div>';
        }
      }
      // Alt layer: Key | Workspace | App
      else if (currentLayer === 'alt') {
        for (const [key, b] of bindings) {
          const keyLabel = KEY_LABELS[key] || key.toUpperCase();
          const dotsHtml = (b.sources || [b.source]).map(s =>
            '<span class="ref-source-dot ' + s + '"></span>'
          ).join('');

          html += '<div class="ref-row three-col">' +
            '<span class="ref-key">' + keyLabel + '</span>' +
            '<span class="ref-action">Workspace ' + b.action + '</span>' +
            '<span class="ref-tile">' + (b.app || '') + '</span>' +
            '<span class="ref-source-dots">' + dotsHtml + '</span>' +
            '</div>';
        }
      }
      // Alt+Shift: Key | Action | App
      else if (currentLayer === 'alt-shift') {
        for (const [key, b] of bindings) {
          const keyLabel = KEY_LABELS[key] || key.toUpperCase();
          const dotsHtml = (b.sources || [b.source]).map(s =>
            '<span class="ref-source-dot ' + s + '"></span>'
          ).join('');

          html += '<div class="ref-row three-col">' +
            '<span class="ref-key">' + keyLabel + '</span>' +
            '<span class="ref-action">Move to ' + key.toUpperCase() + ' + follow</span>' +
            '<span class="ref-tile">' + (b.app || '') + '</span>' +
            '<span class="ref-source-dots">' + dotsHtml + '</span>' +
            '</div>';
        }
      }
      // Service: Key | Action
      else {
        for (const [key, b] of bindings) {
          const keyLabel = KEY_LABELS[key] || key.toUpperCase();
          const dotsHtml = (b.sources || [b.source]).map(s =>
            '<span class="ref-source-dot ' + s + '"></span>'
          ).join('');

          html += '<div class="ref-row two-col">' +
            '<span class="ref-key">' + keyLabel + '</span>' +
            '<span class="ref-action">' + b.desc + '</span>' +
            '<span class="ref-source-dots">' + dotsHtml + '</span>' +
            '</div>';
        }
      }

      html += '</div></div>';
      container.innerHTML = html;
    }

    // ============================================================
    // EVENTS
    // ============================================================

    document.querySelectorAll('.layer-tab').forEach(t => {
      t.addEventListener('click', () => {
        currentLayer = t.dataset.layer;
        lockedKey = null;
        renderTabs();
        renderKeyboard();
        renderRefPanel();
        clearTooltip();
      });
    });

    document.addEventListener('keydown', e => {
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
      const layers = { '1': 'hyper', '2': 'alt', '3': 'alt-shift', '4': 'service' };
      if (layers[e.key]) {
        currentLayer = layers[e.key];
        lockedKey = null;
        renderTabs();
        renderKeyboard();
        renderRefPanel();
        clearTooltip();
      }
      if (e.key === 'Escape' && lockedKey) {
        lockedKey = null;
        renderKeyboard();
        clearTooltip();
      }
    });

    // ============================================================
    // INIT
    // ============================================================

    renderTabs();
    renderKeyboard();
    renderRefPanel();
  </script>
</body>
</html>
